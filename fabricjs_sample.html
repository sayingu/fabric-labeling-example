<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Page Title</title>
    <!-- <link rel="stylesheet" type="text/css" media="screen" href="main.css"> -->
    <script src="http://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
    <script src="fabric.min.js"></script>
    <style>.canvas-container{float: left;}</style>
</head>

<body>
    <script>
    $(document).ready(function(){
        let rectStep = 0, rectPosX = 0, rectPosY = 0, rectPoint1;

        var loadImg = function (url) {
            fabric.Image.fromURL(url, function (img) {
                canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
                    scaleX: canvas.width / img.width,
                    scaleY: canvas.height / img.height
                });
            });
        }

        var canvas = this.__canvas = new fabric.Canvas('c', {
            //isDrawingMode: true
        });

        canvas.on('mouse:down', function (opt) {
            var evt = opt.e;
            if (evt.altKey === true) {
                this.isDragging = true;
                this.selection = false;
                this.lastPosX = evt.clientX;
                this.lastPosY = evt.clientY;
            }

            if (rectStep == 1) {
                rectPoint1 = new fabric.Circle({
                    radius: 5,
                    fill: 'green',
                    left: evt.clientX,
                    top: evt.clientY
                });
                canvas.add(rectPoint1);

                rectPosX = evt.clientX;
                rectPosY = evt.clientY;

                rectStep = 2;
            } else if (rectStep == 2) {
                canvas.remove(rectPoint1);

                canvas.add(new fabric.Rect({
                    top: rectPosY,
                    left: rectPosX,
                    width: evt.clientX - rectPosX,
                    height: evt.clientY - rectPosY,
                    stroke: 'red',
                    strokeWidth: 5,
                    fill: 'rgba(0,0,0,0)'
                }));

                rectPosX = 0;
                rectPoxY = 0;
                rectStep = 0;
            }
        });
        canvas.on('mouse:move', function (opt) {
            if (this.isDragging) {
                var evt = opt.e;
                var zoom = canvas.getZoom();
                if (zoom > 1) {
                    this.viewportTransform[4] += evt.clientX - this.lastPosX;
                    this.viewportTransform[5] += evt.clientY - this.lastPosY;

                    if (this.viewportTransform[4] >= 0) {
                        this.viewportTransform[4] = 0;
                    } else if (this.viewportTransform[4] < canvas.getWidth() - canvas.getWidth() * zoom) {
                        this.viewportTransform[4] = canvas.getWidth() - canvas.getWidth() * zoom;
                    }
                    if (this.viewportTransform[5] >= 0) {
                        this.viewportTransform[5] = 0;
                    } else if (this.viewportTransform[5] < canvas.getHeight() - canvas.getHeight() * zoom) {
                        this.viewportTransform[5] = canvas.getHeight() - canvas.getHeight() * zoom;
                    }

                    this.requestRenderAll();
                    this.lastPosX = evt.clientX;
                    this.lastPosY = evt.clientY;
                }
            }
        });
        canvas.on('mouse:up', function (opt) {
            this.isDragging = false;
            this.selection = true;
        });
        canvas.on('mouse:wheel', function (opt) {
            var delta = opt.e.deltaY;
            var zoom = canvas.getZoom();
            zoom = zoom + delta / 200;
            if (zoom > 10) zoom = 10;
            if (zoom < 1) zoom = 1;
            canvas.zoomToPoint({ x: opt.e.offsetX, y: opt.e.offsetY }, zoom);
            opt.e.preventDefault();
            opt.e.stopPropagation();
            if (this.viewportTransform[4] >= 0) {
                this.viewportTransform[4] = 0;
            } else if (this.viewportTransform[4] < canvas.getWidth() - canvas.getWidth() * zoom) {
                this.viewportTransform[4] = canvas.getWidth() - canvas.getWidth() * zoom;
            }
            if (this.viewportTransform[5] >= 0) {
                this.viewportTransform[5] = 0;
            } else if (this.viewportTransform[5] < canvas.getHeight() - canvas.getHeight() * zoom) {
                this.viewportTransform[5] = canvas.getHeight() - canvas.getHeight() * zoom;
            }

            if (zoom == 1) {
                zoomEl.value = 0;
            } else {
                zoomEl.value = (zoom - 1) * 10;
            }
            zoomEl.previousSibling.innerHTML = Math.round(zoom * 100) + '%';
            /*
            if (zoom < 400 / 1000) {
                this.viewportTransform[4] = 200 - 1000 * zoom / 2;
                this.viewportTransform[5] = 200 - 1000 * zoom / 2;
            } else {
                if (vpt[4] >= 0) {
                    this.viewportTransform[4] = 0;
                } else if (vpt[4] < canvas.getWidth() - 1000 * zoom) {
                    this.viewportTransform[4] = canvas.getWidth() - 1000 * zoom;
                }
                if (vpt[5] >= 0) {
                    this.viewportTransform[5] = 0;
                } else if (vpt[5] < canvas.getHeight() - 1000 * zoom) {
                    this.viewportTransform[5] = canvas.getHeight() - 1000 * zoom;
                }
            }
            */
        });

        loadImg('7KE82C0A300_7KE820552K0_7KE820552K0A1_TRPR2103_5885_517_6962_-694.383_-578.633___33_99.JPG');

        var drawingOptionsEl = $('drawing-mode-options'),
            drawingColorEl = $('drawing-color'),
            drawingShadowColorEl = $('drawing-shadow-color'),
            drawingShadowWidth = $('drawing-shadow-width'),
            drawingShadowOffset = $('drawing-shadow-offset');

        $('#rad-mode-rect').on('click', function(){
            // TODO 커서를 점 모양으로, 상하좌우 직선 표시
            rectStep = 1;
        });

        // 초기화 버튼
        $('#btn-canvas-clear').on("click", function(){
            canvas.clear();
            loadImg('7KE82C0A300_7KE820552K0_7KE820552K0A1_TRPR2103_5885_517_6962_-694.383_-578.633___33_99.JPG');
        })
        
        // 줌 컨트롤
        $('#zoom').on("change", function(){
            var zoom = this.value;
            if (zoom < 1) {
                zoom = 1;
            } else {
                zoom = 1 + zoom / 10;
            }
            canvas.zoomToPoint({ x: canvas.getWidth() / 2, y: canvas.getHeight() / 2 }, zoom);
            this.previousSibling.innerHTML = Math.round(zoom * 100) + '%';
        });
    });
    </script>
    <div style="float: left;">
        <canvas id="c" width="500" height="500" style="border:1px solid #aaa;"></canvas>

        <div style="display: inline-block; margin-left: 10px; ">
            <label for="zoom">Zoom:</label>
            <span class="info">100%</span><input type="range" value="1" min="0" max="90" id="zoom">
            <br />
            <br />

            <label><input type="radio" name="rad-mode" value="Select" checked />
                Select<br />
                * Mouse wheel down/up: zoom in/out picture<br />
                * Alt + dragging: move around the picture<br />
                <br />
            </label>
            <label><input type="radio" id="rad-mode-rect" name="rad-mode" value="Rectangle" />Rectangle</label>
            <label><input type="radio" name="rad-mode" value="Point" />Point</label>
            <br />
            <br />

            <button id="btn-canvas-clear">Clear</button>
            <br />
            <br />

            <label for="drawing-mode-selector">Mode:</label>
            <select id="drawing-mode-selector">
                <option>Pencil</option>
                <option>Circle</option>
                <option>Spray</option>
                <option>Pattern</option>

                <option>hline</option>
                <option>vline</option>
                <option>square</option>
                <option>diamond</option>
                <option>texture</option>
            </select><br>

            <label for="drawing-color">Line color:</label>
            <input type="color" value="#005E7A" id="drawing-color"><br>

            <label for="drawing-shadow-color">Shadow color:</label>
            <input type="color" value="#005E7A" id="drawing-shadow-color"><br>

            <label for="drawing-shadow-width">Shadow width:</label>
            <span class="info">0</span><input type="range" value="0" min="0" max="50" id="drawing-shadow-width"><br>

            <label for="drawing-shadow-offset">Shadow offset:</label>
            <span class="info">0</span><input type="range" value="0" min="0" max="50" id="drawing-shadow-offset"><br>
        </div>
    </div>
</body>

</html>